<!DOCTYPE html>
<html>
<head>
	<title>Guild Wars 2 Trading Post Desktop Notifications</title>
</head>
<body>
<table id="tp"><tbody></tbody></table>
<script>
var access_token = location.search ? location.search.substr(1) : function() {
	var key = prompt('What is your API key? (https://account.arena.net/applications)', '');
	if (key === null) {
		location = 'https://account.arena.net/applications';
		throw "no key, no TP";
	}
	location.search = key;
	return key;
}();

var table = document.querySelector('#tp tbody');

var cache = JSON.parse(localStorage['gw2tp_' + access_token] || '{}');

window.onbeforeunload = function() {
	localStorage['gw2tp_' + access_token] = JSON.stringify(cache);
};

function get(url) {
	return new Promise(function(resolve, reject) {
		var xhr = new XMLHttpRequest();
		xhr.open('GET', url);
		xhr.onload = function() {
			if (xhr.status == 200) {
				resolve({
					'body': JSON.parse(xhr.responseText),
					'header': function(name) {
						return xhr.getResponseHeader(name);
					}
				});
			} else {
				reject(xhr.statusText + '\n' + xhr.responseText);
			}
		};
		xhr.onerror = function() {
			reject(xhr.statusText);
		};
		xhr.send();
	});
}

function delayGet(ms, url) {
	return new Promise(function(resolve, reject) {
		setTimeout(function() {
			get(url).then(resolve, reject);
		}, ms);
	});
}

cache.entries = cache.entries || {};
cache.items = cache.items || {};
var itemQueue = [];

Object.keys(cache.entries).map(parseInt).sort().forEach(function(id) {
	doEntry(cache.entries[id]);
});

function addEntry(entry) {
	if (entry.id in cache.entries) {
		return;
	}
	cache.entries[entry.id] = entry;
	doEntry(entry);
}

function doEntry(entry) {
	var row = document.createElement('tr');
	row.id = 'tp' + entry.id;

	var quantityCell = document.createElement('td');
	quantityCell.textContent = entry.quantity;
	row.appendChild(quantityCell);

	var itemCell = document.createElement('th');
	itemCell.textContent = '???';
	row.appendChild(itemCell);

	var priceCell = document.createElement('td');
	priceCell.textContent = entry.price;
	row.appendChild(priceCell);

	var createdCell = document.createElement('td');
	createdCell.textContent = entry.created;
	row.appendChild(createdCell);

	var purchasedCell = document.createElement('td');
	purchasedCell.textContent = entry.purchased;
	row.appendChild(purchasedCell);

	table.insertBefore(row, table.firstChild);
	if (entry.item_id in cache.items) {
		onEntry(entry, cache.items[entry.item_id], itemCell);
		return;
	}
	itemQueue.push({
		'id': entry.item_id,
		'callback': function(item) {
			onEntry(entry, item, itemCell);
		}
	});
}

function onEntry(entry, item, cell) {
	if (new Date() - new Date(entry.purchased) < 60 * 60 * 1000) {
		var n = new Notification('Sold: ' + entry.quantity + 'Ã— ' + item.name, {
			'icon': item.icon
		});
		n.onshow = function() {
			setTimeout(function() {
				n.close();
			}, 15 * 1000);
		};
	}
	var img = document.createElement('img');
	img.src = item.icon;
	img.alt = '';
	cell.appendChild(img);
	cell.appendChild(document.createTextNode(' ' + item.name));
}

function flushItemQueue() {
	if (itemQueue.length == 0) {
		return;
	}
	var callbacks = {};
	itemQueue.forEach(function(queue) {
		callbacks[queue.id] = callbacks[queue.id] || [];
		callbacks[queue.id].push(queue.callback);
	});
	itemQueue = [];
	return get('https://api.guildwars2.com/v2/items?ids=' + Object.keys(callbacks).join(',')).then(function(data) {
		data.body.forEach(function(item) {
			cache.items[item.id] = item;
			callbacks[item.id].forEach(function(cb) {
				cb(item);
			});
		});
	});
}
Notification.requestPermission(function(permission) {
	if (permission != 'granted') {
		return;
	}
	function handle(data) {
		if (data.body.some(function(entry) {
			return entry.id in cache.entries;
		})) {
			data.body.reverse().forEach(addEntry);
			return flushItemQueue();
		}

		var p = Promise.resolve(undefined);
		for (var i = data.header("X-Page-Total") - 1; i >= 0; i--) {
			p = p.then(function(i) {
				return function() {
					return get('https://api.guildwars2.com/v2/commerce/transactions/history/sells?page=' + i + '&access_token=' + access_token).then(function(data) {
						data.body.reverse().forEach(addEntry);
					}).then(flushItemQueue);
				};
			}(i));
		}
	}
	const url = 'https://api.guildwars2.com/v2/commerce/transactions/history/sells?access_token=' + access_token;
	get(url).then(handle).then(function repeat() {
		return delayGet(60 * 1000, url).then(handle).then(repeat);
	}).catch(function(err) {
		throw err;
	});
});
</script>
</body>